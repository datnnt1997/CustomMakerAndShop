"use strict"
$(function(){function t(t){t.target.set({cornerSize:T}),i(t),$(".cvtoolbox","#centerLayoutContainer").show(),t.target.isType("i-text")?(g(t.target),$(".texttoolbox","#rightLayoutContainer").show()):$(".texttoolbox","#rightLayoutContainer").hide()}function e(t){$(".cvtoolbox","#centerLayoutContainer").hide(),$(".cvtoolbox_info","#centerLayoutContainer").hide(),$(".texttoolbox","#rightLayoutContainer").hide()}function o(t){i(t),t.target.isType("i-text")&&0==t.target.get("text").length&&w.remove(t.target)}function i(t){if(t.target.isType("image")&&(t.target.get("scaleX")>1||t.target.get("scaleY")>1))u("<i class='fa fa-warning'></i> The scaled image is larger than the original image. The quality may decrease.")
else if(t.target.isType("group")){for(var e=t.target.getObjects(),o=t.target.get("scaleX"),i=t.target.get("scaleY"),n=!1,a=0;a<e.length;a++)if(e[a].isType("image")&&(e[a].get("scaleX")*o>1||e[a].get("scaleY")*i>1)){u("<i class='fa fa-warning'></i> The scaled image is larger than the original image. The quality may decrease."),n=!0
break}n||f("")}else f("")}function n(t){var e=10
O[$(w.getElement()).attr("id")]={width:w.get("width")/w.getZoom()-t.target.get("left")-e,scaleX:t.target.get("scaleX")},t.target.setSelectionEnd(t.target.get("text").length),t.target.setSelectionStart(t.target.get("text").length),w.renderAll(),g(t.target)}function a(t){t.target.isType("i-text")&&g(t.target)}function l(t){if(t.target.initDimensions(),t.target.get("text").length>0){var e=$(w.getElement()).attr("id"),o=O[e].width/t.target.getScaledWidth();(1>o||O[e].scaleX>t.target.get("scaleX"))&&(t.target.get("scaleX")*o>O[e].scaleX&&(o=O[e].scaleX/t.target.get("scaleX")),t.target.set("scaleX",t.target.get("scaleX")*o),t.target.set("scaleY",t.target.get("scaleY")*o),t.target.setCoords(),w.renderAll())}}function r(){var t=$("input[name=form_shirt_type]:checked","#leftLayoutContainer").val(),e=$("input[name=form_shirt_color]:checked","#leftLayoutContainer").val(),o=$.grep(A[t].color,function(t){return t.id==e})
o.length>0&&$("#img_shirt").attr("src","images/shirts/"+A[t].filename+"_"+o[0].filename+"_"+j+".png")}function c(){$("#centerLayoutContainer").height($("#centerLayoutContainer div.shirt").width())
var t=s()
$("#div_canvas_front").css("margin-top",M*t),$("#div_canvas_back").css("margin-top",M*t),k.setWidth(X*t),k.setHeight(S*t),k.setZoom(d()),k.renderAll(),C.setWidth(X*t),C.setHeight(S*t),C.setZoom(d()),C.renderAll()}function s(){return $("#centerLayoutContainer div.shirt").width()/L}function d(){return X*s()/R}function f(t){$(".cvtoolbox_info div span","#centerLayoutContainer").text(t),$(".cvtoolbox_info","#centerLayoutContainer").removeClass("warning_msg").show()}function u(t){$(".cvtoolbox_info div span","#centerLayoutContainer").html(t),$(".cvtoolbox_info","#centerLayoutContainer").addClass("warning_msg").show()}function g(t){var e='<div class="btn-group" data-toggle="buttons">'
e+="bold"==t.get("fontWeight")?'<label class="btn btn-default active" id="texttoolbox_bold"><input type="checkbox" autocomplete="off" istool="bold" checked><i class="fa fa-bold"></i></label>':'<label class="btn btn-default" id="texttoolbox_bold"><input type="checkbox" autocomplete="off" istool="bold"><i class="fa fa-bold"></i></label>',e+="italic"==t.get("fontStyle")?'<label class="btn btn-default active" id="texttoolbox_italic"><input type="checkbox" autocomplete="off" istool="italic" checked><i class="fa fa-italic"></i></label>':'<label class="btn btn-default" id="texttoolbox_italic"><input type="checkbox" autocomplete="off" istool="italic"><i class="fa fa-italic"></i></label>',e+=t.get("underline")?'<label class="btn btn-default active" id="texttoolbox_underline"><input type="checkbox" autocomplete="off" istool="underline" checked><i class="fa fa-underline"></i></label>':'<label class="btn btn-default" id="texttoolbox_underline"><input type="checkbox" autocomplete="off" istool="underline"><i class="fa fa-underline"></i></label>',e+=t.get("linethrough")?'<label class="btn btn-default active" id="texttoolbox_strikethrough"><input type="checkbox" autocomplete="off" istool="strikethrough" checked><i class="fa fa-strikethrough"></i></label>':'<label class="btn btn-default" id="texttoolbox_strikethrough"><input type="checkbox" autocomplete="off" istool="strikethrough"><i class="fa fa-strikethrough"></i></label>',e+=t.isEditing?'<label class="btn btn-default active" id="texttoolbox_edit"><input type="checkbox" autocomplete="off" istool="edit" checked><i class="fa fa-pencil-square-o fa-lg"></i></label>':'<label class="btn btn-default" id="texttoolbox_edit"><input type="checkbox" autocomplete="off" istool="edit"><i class="fa fa-pencil-square-o fa-lg"></i></label>',e+="</div>",e+='<div class="input-group colorpicker-component" id="texttoolbox_color">',e+='Text color&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="btn btn-default add-on"><i></i></span>',e+="</div>",e+='<div class="input-group">',e+='Font&nbsp;<select id="texttoolbox_font" style="width: calc(100% - 40px);"><option value="Times New Roman">Times New Roman</option><option value="Pacifico">Pacifico</option><option value="VT323">VT323</option><option value="Quicksand">Quicksand</option><option value="Inconsolata">Inconsolata</option></select>',e+="</div>",$(".texttoolbox","#rightLayoutContainer").html(e),$("#texttoolbox_color").colorpicker({format:"hex",color:t.get("fill")}).on("changeColor",h),$("#texttoolbox_font").val(t.get("fontFamily")),$("#texttoolbox_font").on("change",function(t){var e=w.getActiveObject()
e&&e.isType("i-text")&&("Times New Roman"!==this.value?b(this.value,e):(e.set("fontFamily",this.value),w.renderAll()))})}function b(t,e){var o=new FontFaceObserver(t)
o.load().then(function(){e.set("fontFamily",t),w.renderAll()})}function h(t){var e=w.getActiveObject()
e&&e.isType("i-text")&&(e.set("fill",t.color.toHex()),w.renderAll())}function v(){var t=w.getActiveObject()
t&&t.isType("i-text")&&($("#texttoolbox_bold input").prop("checked")?t.set("fontWeight","bold"):t.set("fontWeight","normal"),w.renderAll())}function p(){var t=w.getActiveObject()
t&&t.isType("i-text")&&($("#texttoolbox_italic input").prop("checked")?t.set("fontStyle","italic"):t.set("fontStyle","normal"),w.renderAll())}function m(){var t=w.getActiveObject()
t&&t.isType("i-text")&&($("#texttoolbox_underline input").prop("checked")?t.set("underline",!0):t.set("underline",!1),w.renderAll())}function x(){var t=w.getActiveObject()
t&&t.isType("i-text")&&($("#texttoolbox_strikethrough input").prop("checked")?t.set("linethrough",!0):t.set("linethrough",!1),w.renderAll())}function _(){var t=w.getActiveObject()
t&&t.isType("i-text")&&($("#texttoolbox_edit input").prop("checked")?t.enterEditing():t.exitEditing(),w.renderAll())}function y(t){$("#albumModal").modal("hide"),fabric.Image.fromURL(t,function(t){w.add(t),t.get("width")*d()>w.get("width")/2&&t.scaleToWidth(w.get("width")/2),t.viewportCenter().setCoords(),w.setActiveObject(t),w.renderAll()})}var w,k,C,A={1:{filename:"men1",color:[{id:"1",filename:"blue",color:"0268b0"},{id:"2",filename:"white",color:"ffffff"}]},2:{filename:"women",color:[{id:"3",filename:"black",color:"000000"},{id:"4",filename:"white",color:"ffffff"}]}},L=570,T=20,j="front",O={},X=260,S=350,M=155,R=1e3,W=250
k=new fabric.Canvas("mainCanvas_front",{preserveObjectStacking:!0}),C=new fabric.Canvas("mainCanvas_back",{preserveObjectStacking:!0}),w=k,c(),fabric.Image.fromURL("images/album/image1.png",function(t){w.add(t),t.scaleToWidth(.8*w.get("width")),t.viewportCenter().setCoords(),w.renderAll()})
var F=new fabric.IText("Hello",{fill:"#ff0000",stroke:"#000",fontSize:R})
w.add(F),F.scaleToWidth(w.get("width")/2),F.viewportCenterH().setCoords(),w.renderAll(),k.on("selection:created",t),C.on("selection:created",t),k.on("selection:updated",t),C.on("selection:updated",t),k.on("selection:cleared",e),C.on("selection:cleared",e),k.on("object:modified",o),C.on("object:modified",o),k.on("text:editing:entered",n),C.on("text:editing:entered",n),k.on("text:editing:exited",a),C.on("text:editing:exited",a),k.on("text:changed",l),C.on("text:changed",l),$(window).on("resize",function(){c()}),$("#toolbox_left").on("click",function(){f("Move left")
var t=w.getActiveObject()
return t&&(t.set("left",t.get("left")-1/d()).setCoords(),w.renderAll()),!1}),$("#toolbox_right").on("click",function(){f("Move right")
var t=w.getActiveObject()
return t&&(t.set("left",t.get("left")+1/d()).setCoords(),w.renderAll()),!1}),$("#toolbox_up").on("click",function(){f("Move up")
var t=w.getActiveObject()
return t&&(t.set("top",t.get("top")-1/d()).setCoords(),w.renderAll()),!1}),$("#toolbox_down").on("click",function(){f("Move down")
var t=w.getActiveObject()
return t&&(t.set("top",t.get("top")+1/d()).setCoords(),w.renderAll()),!1}),$("#toolbox_center").on("click",function(){f("Center")
var t=w.getActiveObject()
return t&&(t.viewportCenter().setCoords(),w.renderAll()),!1}),$("#toolbox_centerh").on("click",function(){f("Center horizontally")
var t=w.getActiveObject()
return t&&(t.viewportCenterH().setCoords(),w.renderAll()),!1}),$("#toolbox_centerv").on("click",function(){f("Center vertically")
var t=w.getActiveObject()
return t&&(t.viewportCenterV().setCoords(),w.renderAll()),!1}),$("#toolbox_flipx").on("click",function(){f("Flip vertically")
var t=w.getActiveObject()
return t&&(t.set("flipX",!t.get("flipX")),w.renderAll()),!1}),$("#toolbox_flipy").on("click",function(){f("Flip horizontally")
var t=w.getActiveObject()
return t&&(t.set("flipY",!t.get("flipY")),w.renderAll()),!1}),$("#toolbox_totop").on("click",function(){f("Bring to front")
var t=w.getActiveObject()
return t&&(w.bringToFront(t),w.renderAll()),!1}),$("#toolbox_tobottom").on("click",function(){f("Send to back")
var t=w.getActiveObject()
return t&&(w.sendToBack(t),w.renderAll()),!1}),$("#toolbox_remove").on("click",function(){f("Remove")
var t=w.getActiveObject(),e=w.getActiveObjects()
return e.length>1?(w.discardActiveObject(),e.forEach(function(t){w.remove(t)})):t&&w.remove(t),!1}),$("input[name=form_shirt_type]","#leftLayoutContainer").on("change",function(){for(var t="",e=0;e<A[this.value].color.length;e++)t+='<div class="btn colorButton '+(0==e?"active":"")+'" style="background-color: #'+A[this.value].color[e].color+';"><input type="radio" name="form_shirt_color" value="'+A[this.value].color[e].id+'" autocomplete="off" '+(0==e?"checked":"")+" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>"
return A[this.value].color.length<2?($("#div_colors_title").hide(),$("#div_colors").html(t).hide()):($("#div_colors_title").show(),$("#div_colors").html(t).show()),$("#img_shirt").attr("src","images/shirts/"+A[this.value].filename+"_"+A[this.value].color[0].filename+"_"+j+".png"),!1}),$("#div_colors").on("change",function(t){return $(t.target).is("input")&&r(),!1}),$("input[name=form_shirt_side]","#centerLayoutContainer").on("change",function(){if(j=this.value,"front"==j?(w=k,$("#div_canvas_back").hide(),$("#div_canvas_front").show()):(w=C,$("#div_canvas_front").hide(),$("#div_canvas_back").show()),w.getActiveObject()){$(".cvtoolbox","#centerLayoutContainer").show()
var t=w.getActiveObject()
t&&t.isType("i-text")?(g(t),$(".texttoolbox","#rightLayoutContainer").show()):$(".texttoolbox","#rightLayoutContainer").hide()}else $(".cvtoolbox","#centerLayoutContainer").hide(),$(".cvtoolbox_info","#centerLayoutContainer").hide(),$(".texttoolbox","#rightLayoutContainer").hide()
return r(),!1}),$("#albumModal").on("click",function(t){var e=$(t.target)
return e.is("img")&&e.attr("bgsrc")?(y(e.attr("bgsrc")),!1):void 0}),$("input[name=image_upload]","#leftLayoutContainer").on("change",function(){if(this.value&&this.files&&this.files[0]){var t=$("#frm_upload label i"),e=$("#leftLayoutContainer .message")
t.removeClass("fa-picture-o").addClass("fa-spinner fa-pulse"),e.text("")
var o=new FileReader
o.onload=function(o){$("input[name=image_upload]","#leftLayoutContainer").val(""),t.removeClass("fa-spinner fa-pulse").addClass("fa-picture-o"),e.text(""),fabric.Image.fromURL(o.target.result,function(t){w.add(t),t.get("width")*d()>w.get("width")/2&&t.scaleToWidth(w.get("width")/2),t.viewportCenter().setCoords(),w.setActiveObject(t),w.renderAll()})},o.readAsDataURL(this.files[0])}return!1}),$("#btn_addtext").on("click",function(){$("#leftLayoutContainer .message").text("")
var t=new fabric.IText("Abc",{fill:"#000",stroke:"#000",fontSize:R})
return w.add(t),t.scaleToWidth(w.get("width")/2),t.viewportCenter().setCoords(),w.setActiveObject(t),w.renderAll(),!1}),$("#reviewModal").on("show.bs.modal",function(){w.discardActiveObject(),w.renderAll()
var t=$("#reviewModal .shirtdesign"),e=$("#reviewModal .shirt")
t.find("img").attr("src",w.toDataURL({format:"png",multiplier:Math.ceil(1e4/(d()*R/W))/1e4})),e.find("img").attr("src",$("#img_shirt").attr("src")),t.width(W),e.width(W*L/X),$("#reviewModal .modal-body").height(e.width()),t.css("margin-top",M*e.width()/L)}),navigator.userAgent.match(/iPhone|iPad|iPod/i)&&$(".modal").on("show.bs.modal",function(){$(this).css({position:"absolute",marginTop:$(window).scrollTop()+"px",bottom:"auto"})}),$.each(A,function(t,e){for(t=0;t<e.color.length;t++)(new Image).src="images/shirts/"+e.filename+"_"+e.color[t].filename+"_front.png",(new Image).src="images/shirts/"+e.filename+"_"+e.color[t].filename+"_back.png"}),$(".texttoolbox","#rightLayoutContainer").on("change",function(t){var e=$(t.target)
if(e.is("input")&&e.attr("istool")){switch(e.attr("istool")){case"bold":v()
break
case"italic":p()
break
case"underline":m()
break
case"strikethrough":x()
break
case"edit":_()}return!1}}),$("#btnDownload").on("click",function(){this.href=w.toDataURL({format:"png",multiplier:Math.ceil(1e4/(d()*R/W))/1e4}),this.download="download.png"})})
